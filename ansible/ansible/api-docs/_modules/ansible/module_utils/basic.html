

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ansible.module_utils.basic &mdash; Ansible 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Ansible 1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Ansible
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="simple">
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Ansible</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>ansible.module_utils.basic</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ansible.module_utils.basic</h1><div class="highlight"><pre>
<span class="c"># This code is part of Ansible, but is an independent component.</span>
<span class="c"># This particular file snippet, and this file snippet only, is BSD licensed.</span>
<span class="c"># Modules you write using this snippet, which is embedded dynamically by Ansible</span>
<span class="c"># still belong to the author of the module, and may assign their own license</span>
<span class="c"># to the complete work.</span>
<span class="c">#</span>
<span class="c"># Copyright (c), Michael DeHaan &lt;michael.dehaan@gmail.com&gt;, 2012-2013</span>
<span class="c"># All rights reserved.</span>
<span class="c">#</span>
<span class="c"># Redistribution and use in source and binary forms, with or without modification,</span>
<span class="c"># are permitted provided that the following conditions are met:</span>
<span class="c">#</span>
<span class="c">#    * Redistributions of source code must retain the above copyright</span>
<span class="c">#      notice, this list of conditions and the following disclaimer.</span>
<span class="c">#    * Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c">#      this list of conditions and the following disclaimer in the documentation</span>
<span class="c">#      and/or other materials provided with the distribution.</span>
<span class="c">#</span>
<span class="c"># THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND</span>
<span class="c"># ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED</span>
<span class="c"># WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.</span>
<span class="c"># IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</span>
<span class="c"># INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,</span>
<span class="c"># PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</span>
<span class="c"># INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
<span class="c"># LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE</span>
<span class="c"># USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="c">#</span>

<span class="n">BOOLEANS_TRUE</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;yes&#39;</span><span class="p">,</span> <span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;1&#39;</span><span class="p">,</span> <span class="s">&#39;true&#39;</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">]</span>
<span class="n">BOOLEANS_FALSE</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;no&#39;</span><span class="p">,</span> <span class="s">&#39;off&#39;</span><span class="p">,</span> <span class="s">&#39;0&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">,</span> <span class="s">&#39;False&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">False</span><span class="p">]</span>
<span class="n">BOOLEANS</span> <span class="o">=</span> <span class="n">BOOLEANS_TRUE</span> <span class="o">+</span> <span class="n">BOOLEANS_FALSE</span>

<span class="c"># ansible modules can be written in any language.  To simplify</span>
<span class="c"># development of Python modules, the functions available here can</span>
<span class="c"># be used to do many common tasks</span>

<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">pipes</span>
<span class="kn">import</span> <span class="nn">shlex</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">grp</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">platform</span>
<span class="kn">import</span> <span class="nn">errno</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">chain</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">syslog</span>
    <span class="n">HAS_SYSLOG</span><span class="o">=</span><span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">HAS_SYSLOG</span><span class="o">=</span><span class="bp">False</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># Python 2</span>
    <span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">imap</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="n">imap</span> <span class="o">=</span> <span class="nb">map</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># Python 2</span>
    <span class="nb">basestring</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="nb">basestring</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># Python 2</span>
    <span class="nb">unicode</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="nb">unicode</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c"># Python 2.6+</span>
    <span class="nb">bytes</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="c"># Python 2.4</span>
    <span class="nb">bytes</span> <span class="o">=</span> <span class="nb">str</span>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">dict</span><span class="o">.</span><span class="n">iteritems</span>
<span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c"># Python 2</span>
<div class="viewcode-block" id="iteritems"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.iteritems">[docs]</a>    <span class="k">def</span> <span class="nf">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span></div>

<span class="k">try</span><span class="p">:</span>
    <span class="nb">reduce</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">NUMBERTYPES</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="c"># Python 3</span>
    <span class="n">NUMBERTYPES</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

<span class="c"># Python2 &amp; 3 way to get NoneType</span>
<span class="n">NoneType</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Sequence</span><span class="p">,</span> <span class="n">Mapping</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c"># python2.5</span>
    <span class="n">Sequence</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
    <span class="n">Mapping</span> <span class="o">=</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">KeysView</span>
    <span class="n">SEQUENCETYPE</span> <span class="o">=</span> <span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="n">KeysView</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">SEQUENCETYPE</span> <span class="o">=</span> <span class="n">Sequence</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">json</span>
    <span class="c"># Detect the python-json library which is incompatible</span>
    <span class="c"># Look for simplejson if that&#39;s the case</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ImportError</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">simplejson</span> <span class="kn">as</span> <span class="nn">json</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{&quot;msg&quot;: &quot;Error: ansible requires the stdlib json or simplejson module, neither was found!&quot;, &quot;failed&quot;: true}&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">SyntaxError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{&quot;msg&quot;: &quot;SyntaxError: probably due to installed simplejson being for a different python version&quot;, &quot;failed&quot;: true}&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">ansible.module_utils.six</span> <span class="kn">import</span> <span class="n">PY2</span><span class="p">,</span> <span class="n">PY3</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">binary_type</span><span class="p">,</span> <span class="n">text_type</span><span class="p">,</span> <span class="n">string_types</span>

<span class="n">HAVE_SELINUX</span><span class="o">=</span><span class="bp">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">selinux</span>
    <span class="n">HAVE_SELINUX</span><span class="o">=</span><span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">systemd</span> <span class="kn">import</span> <span class="n">journal</span>
    <span class="n">has_journal</span> <span class="o">=</span> <span class="bp">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">has_journal</span> <span class="o">=</span> <span class="bp">False</span>

<span class="n">AVAILABLE_HASH_ALGORITHMS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">hashlib</span>

    <span class="c"># python 2.7.9+ and 2.7.0+</span>
    <span class="k">for</span> <span class="n">attribute</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;available_algorithms&#39;</span><span class="p">,</span> <span class="s">&#39;algorithms&#39;</span><span class="p">):</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">algorithms</span><span class="p">:</span>
            <span class="k">break</span>
    <span class="k">if</span> <span class="n">algorithms</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="c"># python 2.5+</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;md5&#39;</span><span class="p">,</span> <span class="s">&#39;sha1&#39;</span><span class="p">,</span> <span class="s">&#39;sha224&#39;</span><span class="p">,</span> <span class="s">&#39;sha256&#39;</span><span class="p">,</span> <span class="s">&#39;sha384&#39;</span><span class="p">,</span> <span class="s">&#39;sha512&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">algorithm</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
        <span class="n">AVAILABLE_HASH_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hashlib</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sha</span>
    <span class="n">AVAILABLE_HASH_ALGORITHMS</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;sha1&#39;</span><span class="p">:</span> <span class="n">sha</span><span class="o">.</span><span class="n">sha</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">md5</span>
        <span class="n">AVAILABLE_HASH_ALGORITHMS</span><span class="p">[</span><span class="s">&#39;md5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">md5</span><span class="o">.</span><span class="n">md5</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c"># a replacement for literal_eval that works with python 2.4. from:</span>
    <span class="c"># https://mail.python.org/pipermail/python-list/2009-September/551880.html</span>
    <span class="c"># which is essentially a cut/paste from an earlier (2.6) version of python&#39;s</span>
    <span class="c"># ast.py</span>
    <span class="kn">from</span> <span class="nn">compiler</span> <span class="kn">import</span> <span class="n">ast</span><span class="p">,</span> <span class="n">parse</span>

    <span class="k">def</span> <span class="nf">literal_eval</span><span class="p">(</span><span class="n">node_or_string</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Safely evaluate an expression node or a string containing a Python</span>
<span class="sd">        expression.  The string or node provided may only consist of the  following</span>
<span class="sd">        Python literal structures: strings, numbers, tuples, lists, dicts,  booleans,</span>
<span class="sd">        and None.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_safe_names</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;None&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;True&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span> <span class="s">&#39;False&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_string</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">node_or_string</span> <span class="o">=</span> <span class="n">parse</span><span class="p">(</span><span class="n">node_or_string</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&#39;eval&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node_or_string</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Expression</span><span class="p">):</span>
            <span class="n">node_or_string</span> <span class="o">=</span> <span class="n">node_or_string</span><span class="o">.</span><span class="n">node</span>

        <span class="k">def</span> <span class="nf">_convert</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Const</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">long</span><span class="p">,</span> <span class="nb">complex</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">node</span><span class="o">.</span><span class="n">value</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Tuple</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_convert</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">List</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">_convert</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">nodes</span><span class="p">))</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">_convert</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_convert</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">_safe_names</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">_safe_names</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">UnarySub</span><span class="p">):</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">_convert</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;malformed string&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_convert</span><span class="p">(</span><span class="n">node_or_string</span><span class="p">)</span>

<span class="n">_literal_eval</span> <span class="o">=</span> <span class="n">literal_eval</span>

<span class="c"># Backwards compat.  There were present in basic.py before</span>
<span class="kn">from</span> <span class="nn">ansible.module_utils.pycompat24</span> <span class="kn">import</span> <span class="n">get_exception</span>

<span class="c"># Internal global holding passed in params.  This is consulted in case</span>
<span class="c"># multiple AnsibleModules are created.  Otherwise each AnsibleModule would</span>
<span class="c"># attempt to read from stdin.  Other code should not use this directly as it</span>
<span class="c"># is an internal implementation detail</span>
<span class="n">_ANSIBLE_ARGS</span> <span class="o">=</span> <span class="bp">None</span>

<span class="n">FILE_COMMON_ARGUMENTS</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
    <span class="n">src</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">mode</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;raw&#39;</span><span class="p">),</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">group</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">seuser</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">serole</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">selevel</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">setype</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">follow</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&#39;bool&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>
    <span class="c"># not taken by the file module, but other modules call file so it must ignore them.</span>
    <span class="n">content</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">no_log</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
    <span class="n">backup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">force</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span>
    <span class="n">remote_src</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="c"># used by assemble</span>
    <span class="n">regexp</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="c"># used by assemble</span>
    <span class="n">delimiter</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="c"># used by assemble</span>
    <span class="n">directory_mode</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(),</span> <span class="c"># used by copy</span>
<span class="p">)</span>

<span class="n">PASSWD_ARG_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^[-]{0,2}pass[-]?(word|wd)?&#39;</span><span class="p">)</span>

<span class="c"># Can&#39;t use 07777 on Python 3, can&#39;t use 0o7777 on Python 2.4</span>
<span class="n">PERM_BITS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;07777&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>      <span class="c"># file mode permission bits</span>
<span class="n">EXEC_PERM_BITS</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;00111&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="c"># execute permission bits</span>
<span class="n">DEFAULT_PERM</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="s">&#39;0666&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>    <span class="c"># default file permission bits</span>


<div class="viewcode-block" id="get_platform"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.get_platform">[docs]</a><span class="k">def</span> <span class="nf">get_platform</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get the systems platform or OS name.</span>

<span class="sd">    For example: &#39;Linux&#39;, &#39;Windows&#39; or &#39;Java&#39;.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The name of the platform as a string. An empty string is returned if the value cannot be determined.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span></div>

<div class="viewcode-block" id="get_distribution"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.get_distribution">[docs]</a><span class="k">def</span> <span class="nf">get_distribution</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get the systems distribution name if applicable.</span>

<span class="sd">    Possible results include: &#39;Amazon&#39;, &#39;SuSE&#39;, &#39;UnitedLinux&#39;, &#39;arch&#39;, &#39;centos&#39;, &#39;debian&#39;, &#39;fedora&#39;, &#39;gentoo&#39;, &#39;mandrake&#39;, &#39;mandriva&#39;, &#39;redhat&#39;, &#39;rocks&#39;, &#39;slackware&#39;, &#39;turbolinux&#39;, &#39;yellowdog&#39;, &#39;OtherLinux&#39;</span>

<span class="sd">    Returns:</span>
<span class="sd">        The name of the distribution as a string. If system is linux, but no known distribution is detected &#39;OtherLinux&#39; is returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">supported_dists</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">_supported_dists</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39;arch&#39;</span><span class="p">,)</span>
            <span class="n">distribution</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">(</span><span class="n">supported_dists</span><span class="o">=</span><span class="n">supported_dists</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">distribution</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/etc/system-release&#39;</span><span class="p">):</span>
                <span class="n">distribution</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">(</span><span class="n">supported_dists</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;system&#39;</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
                <span class="k">if</span> <span class="s">&#39;Amazon&#39;</span> <span class="ow">in</span> <span class="n">distribution</span><span class="p">:</span>
                    <span class="n">distribution</span> <span class="o">=</span> <span class="s">&#39;Amazon&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">distribution</span> <span class="o">=</span> <span class="s">&#39;OtherLinux&#39;</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># FIXME: MethodMissing, I assume?</span>
            <span class="n">distribution</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">dist</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">distribution</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">distribution</span></div>

<div class="viewcode-block" id="get_distribution_version"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.get_distribution_version">[docs]</a><span class="k">def</span> <span class="nf">get_distribution_version</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get the linux distribution version, if applicable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A string or None. If the system is linux, the distribution version number is returned as a string.</span>
<span class="sd">        If system is not linux, None is returned.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">system</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;Linux&#39;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">distribution_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">distribution_version</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s">&#39;/etc/system-release&#39;</span><span class="p">):</span>
                <span class="n">distribution_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">linux_distribution</span><span class="p">(</span><span class="n">supported_dists</span><span class="o">=</span><span class="p">[</span><span class="s">&#39;system&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># FIXME: MethodMissing, I assume?</span>
            <span class="n">distribution_version</span> <span class="o">=</span> <span class="n">platform</span><span class="o">.</span><span class="n">dist</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">distribution_version</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">distribution_version</span></div>

<div class="viewcode-block" id="get_all_subclasses"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.get_all_subclasses">[docs]</a><span class="k">def</span> <span class="nf">get_all_subclasses</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get a list of all class objects that subclass :cls:.</span>

<span class="sd">    Used by modules like :Hardware: or :Network: fact classes to retrieve all subclasses of a given class.</span>
<span class="sd">    __subclasses__() only returns direct subclasses. get_all_subclasses() goes down into the class tree.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of :class: objects.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># Retrieve direct subclasses</span>
    <span class="n">subclasses</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">()</span>
    <span class="n">to_visit</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subclasses</span><span class="p">)</span>
    <span class="c"># Then visit all subclasses</span>
    <span class="k">while</span> <span class="n">to_visit</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">to_visit</span><span class="p">:</span>
            <span class="c"># The current class is now visited, so remove it from list</span>
            <span class="n">to_visit</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
            <span class="c"># Appending all subclasses to visit and keep a reference of available class</span>
            <span class="k">for</span> <span class="n">ssc</span> <span class="ow">in</span> <span class="n">sc</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
                <span class="n">subclasses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssc</span><span class="p">)</span>
                <span class="n">to_visit</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ssc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">subclasses</span></div>


<div class="viewcode-block" id="load_platform_subclass"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.load_platform_subclass">[docs]</a><span class="k">def</span> <span class="nf">load_platform_subclass</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    used by modules like User to have different implementations based on detected platform.  See User</span>
<span class="sd">    module for an example.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">this_platform</span> <span class="o">=</span> <span class="n">get_platform</span><span class="p">()</span>
    <span class="n">distribution</span> <span class="o">=</span> <span class="n">get_distribution</span><span class="p">()</span>
    <span class="n">subclass</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="c"># get the most specific superclass for this platform</span>
    <span class="k">if</span> <span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">get_all_subclasses</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">distribution</span> <span class="o">==</span> <span class="n">distribution</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="n">this_platform</span><span class="p">:</span>
                <span class="n">subclass</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="k">if</span> <span class="n">subclass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">sc</span> <span class="ow">in</span> <span class="n">get_all_subclasses</span><span class="p">(</span><span class="n">cls</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">sc</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="n">this_platform</span> <span class="ow">and</span> <span class="n">sc</span><span class="o">.</span><span class="n">distribution</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">subclass</span> <span class="o">=</span> <span class="n">sc</span>
    <span class="k">if</span> <span class="n">subclass</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">subclass</span> <span class="o">=</span> <span class="n">cls</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">subclass</span><span class="p">)</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">subclass</span><span class="p">)</span></div>


<div class="viewcode-block" id="json_dict_unicode_to_bytes"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.json_dict_unicode_to_bytes">[docs]</a><span class="k">def</span> <span class="nf">json_dict_unicode_to_bytes</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Recursively convert dict keys and values to byte str</span>

<span class="sd">        Specialized for json return because this only handles, lists, tuples,</span>
<span class="sd">        and dict container types (the containers that the json module returns)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">d</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_unicode_to_bytes</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_unicode_to_bytes</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_unicode_to_bytes</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="json_dict_bytes_to_unicode"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.json_dict_bytes_to_unicode">[docs]</a><span class="k">def</span> <span class="nf">json_dict_bytes_to_unicode</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Recursively convert dict keys and values to byte str</span>

<span class="sd">        Specialized for json return because this only handles, lists, tuples,</span>
<span class="sd">        and dict container types (the containers that the json module returns)</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_bytes_to_unicode</span><span class="p">,</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_bytes_to_unicode</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">imap</span><span class="p">(</span><span class="n">json_dict_bytes_to_unicode</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">encoding</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">d</span></div>

<div class="viewcode-block" id="return_values"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.return_values">[docs]</a><span class="k">def</span> <span class="nf">return_values</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Return stringified values from datastructures. For use with removing</span>
<span class="sd">    sensitive values pre-jsonification.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">obj</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Unicode objects should all convert to utf-8</span>
                <span class="c"># (still must deal with surrogateescape on python3)</span>
                <span class="k">yield</span> <span class="n">obj</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">SEQUENCETYPE</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subelement</span> <span class="ow">in</span> <span class="n">return_values</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">subelement</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">subelement</span> <span class="ow">in</span> <span class="n">return_values</span><span class="p">(</span><span class="n">element</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">yield</span> <span class="n">subelement</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)):</span>
        <span class="c"># This must come before int because bools are also ints</span>
        <span class="k">return</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">NUMBERTYPES</span><span class="p">):</span>
        <span class="k">yield</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Unknown parameter type: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="n">obj</span><span class="p">))</span></div>

<div class="viewcode-block" id="remove_values"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.remove_values">[docs]</a><span class="k">def</span> <span class="nf">remove_values</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">no_log_strings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Remove strings in no_log_strings from value.  If value is a container</span>
<span class="sd">    type, then remove a lot more&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="c"># This should work everywhere on python2. Need to check</span>
            <span class="c"># surrogateescape on python3</span>
            <span class="n">bytes_value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">value_is_unicode</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bytes_value</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">value_is_unicode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">bytes_value</span> <span class="ow">in</span> <span class="n">no_log_strings</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;VALUE_SPECIFIED_IN_NO_LOG_PARAMETER&#39;</span>
        <span class="k">for</span> <span class="n">omit_me</span> <span class="ow">in</span> <span class="n">no_log_strings</span><span class="p">:</span>
            <span class="n">bytes_value</span> <span class="o">=</span> <span class="n">bytes_value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">omit_me</span><span class="p">,</span> <span class="s">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_is_unicode</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">unicode</span><span class="p">(</span><span class="n">bytes_value</span><span class="p">,</span> <span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bytes_value</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">SEQUENCETYPE</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">remove_values</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">no_log_strings</span><span class="p">)</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Mapping</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">no_log_strings</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">chain</span><span class="p">(</span><span class="n">NUMBERTYPES</span><span class="p">,</span> <span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">)))):</span>
        <span class="n">stringy_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stringy_value</span> <span class="ow">in</span> <span class="n">no_log_strings</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&#39;VALUE_SPECIFIED_IN_NO_LOG_PARAMETER&#39;</span>
        <span class="k">for</span> <span class="n">omit_me</span> <span class="ow">in</span> <span class="n">no_log_strings</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">omit_me</span> <span class="ow">in</span> <span class="n">stringy_value</span><span class="p">:</span>
                <span class="k">return</span> <span class="s">&#39;VALUE_SPECIFIED_IN_NO_LOG_PARAMETER&#39;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;Value of unknown type: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">value</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">value</span></div>


<div class="viewcode-block" id="heuristic_log_sanitize"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.heuristic_log_sanitize">[docs]</a><span class="k">def</span> <span class="nf">heuristic_log_sanitize</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">no_log_values</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Remove strings that look like passwords from log messages &#39;&#39;&#39;</span>
    <span class="c"># Currently filters:</span>
    <span class="c"># user:pass@foo/whatever and http://username:pass@wherever/foo</span>
    <span class="c"># This code has false positives and consumes parts of logs that are</span>
    <span class="c"># not passwds</span>

    <span class="c"># begin: start of a passwd containing string</span>
    <span class="c"># end: end of a passwd containing string</span>
    <span class="c"># sep: char between user and passwd</span>
    <span class="c"># prev_begin: where in the overall string to start a search for</span>
    <span class="c">#   a passwd</span>
    <span class="c"># sep_search_end: where in the string to end a search for the sep</span>
    <span class="n">output</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">prev_begin</span> <span class="o">=</span> <span class="n">begin</span>
    <span class="n">sep</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">while</span> <span class="n">sep</span><span class="p">:</span>
        <span class="c"># Find the potential end of a passwd</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;@&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">begin</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c"># No passwd in the rest of the data</span>
            <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">begin</span><span class="p">])</span>
            <span class="k">break</span>

        <span class="c"># Search for the beginning of a passwd</span>
        <span class="n">sep</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">sep_search_end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">sep</span><span class="p">:</span>
            <span class="c"># URL-style username+password</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rindex</span><span class="p">(</span><span class="s">&#39;://&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sep_search_end</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c"># No url style in the data, check for ssh style in the</span>
                <span class="c"># rest of the string</span>
                <span class="n">begin</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c"># Search for separator</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sep</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="n">begin</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="c"># No separator; choices:</span>
                <span class="k">if</span> <span class="n">begin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c"># Searched the whole string so there&#39;s no password</span>
                    <span class="c"># here.  Return the remaining data</span>
                    <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">begin</span><span class="p">])</span>
                    <span class="k">break</span>
                <span class="c"># Search for a different beginning of the password field.</span>
                <span class="n">sep_search_end</span> <span class="o">=</span> <span class="n">begin</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="n">sep</span><span class="p">:</span>
            <span class="c"># Password was found; remove it.</span>
            <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">end</span><span class="p">:</span><span class="n">prev_begin</span><span class="p">])</span>
            <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s">&#39;********&#39;</span><span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">begin</span><span class="p">:</span><span class="n">sep</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">prev_begin</span> <span class="o">=</span> <span class="n">begin</span>

    <span class="n">output</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">no_log_values</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">no_log_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">output</span></div>

<div class="viewcode-block" id="is_executable"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.is_executable">[docs]</a><span class="k">def</span> <span class="nf">is_executable</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Determine if the given :path: is executable.</span>

<span class="sd">    Limitations::</span>

<span class="sd">        * Does not account for FSACLs.</span>
<span class="sd">        * Most times we really want to know &quot;Can the current user execute this</span>
<span class="sd">          file&quot;  This function does not tell us that, only if an execute bit is set.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c"># These are all bitfields so first bitwise-or all the permissions we&#39;re</span>
    <span class="c"># looking for, then bitwise-and with the file&#39;s mode to determine if any</span>
    <span class="c"># execute bits are set.</span>
    <span class="k">return</span> <span class="p">((</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MODE</span><span class="p">])</span></div>

<span class="k">def</span> <span class="nf">_load_params</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39; read the modules parameters and store them globally.</span>

<span class="sd">    This function may be needed for certain very dynamic custom modules which</span>
<span class="sd">    want to process the parameters that are being handed the module.  Since</span>
<span class="sd">    this is so closely tied to the implementation of modules we cannot</span>
<span class="sd">    guarantee API stability for it (it may change between versions) however we</span>
<span class="sd">    will try not to break it gratuitously.  It is certainly more future-proof</span>
<span class="sd">    to call this function and consume its outputs than to implement the logic</span>
<span class="sd">    inside it as a copy in your own code.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">global</span> <span class="n">_ANSIBLE_ARGS</span>
    <span class="k">if</span> <span class="n">_ANSIBLE_ARGS</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="nb">buffer</span> <span class="o">=</span> <span class="n">_ANSIBLE_ARGS</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c"># debug overrides to read args from file or cmdline</span>

        <span class="c"># Avoid tracebacks when locale is non-utf8</span>
        <span class="c"># We control the args and we pass them as utf8</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">fd</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
                <span class="nb">buffer</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
                <span class="n">fd</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">buffer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                    <span class="nb">buffer</span> <span class="o">=</span> <span class="nb">buffer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
        <span class="c"># default case, read from stdin</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
                <span class="nb">buffer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">buffer</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">buffer</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">_ANSIBLE_ARGS</span> <span class="o">=</span> <span class="nb">buffer</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="nb">buffer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># This helper used too early for fail_json to work.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{&quot;msg&quot;: &quot;Error: Module unable to decode valid JSON on stdin.  Unable to figure out what parameters were passed&quot;, &quot;failed&quot;: true}&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">json_dict_unicode_to_bytes</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s">&#39;ANSIBLE_MODULE_ARGS&#39;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="c"># This helper does not have access to fail_json so we have to print</span>
        <span class="c"># json output on our own.</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{&quot;msg&quot;: &quot;Error: Module unable to locate ANSIBLE_MODULE_ARGS in json data from stdin.  Unable to figure out what parameters were passed&quot;, &quot;failed&quot;: true}&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<div class="viewcode-block" id="env_fallback"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.env_fallback">[docs]</a><span class="k">def</span> <span class="nf">env_fallback</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39; Load value from environment &#39;&#39;&#39;</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">AnsibleFallbackNotFound</span></div>


<div class="viewcode-block" id="AnsibleFallbackNotFound"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleFallbackNotFound">[docs]</a><span class="k">class</span> <span class="nc">AnsibleFallbackNotFound</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="AnsibleModule"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule">[docs]</a><span class="k">class</span> <span class="nc">AnsibleModule</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">argument_spec</span><span class="p">,</span> <span class="n">bypass_checks</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">no_log</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">check_invalid_arguments</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">mutually_exclusive</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">required_together</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">required_one_of</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">add_file_common_args</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">supports_check_mode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">required_if</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        common code for quickly building an ansible module in Python</span>
<span class="sd">        (although you can write modules in anything that can return JSON)</span>
<span class="sd">        see library/* for examples</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span> <span class="o">=</span> <span class="n">argument_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">supports_check_mode</span> <span class="o">=</span> <span class="n">supports_check_mode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_log</span> <span class="o">=</span> <span class="n">no_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_diff</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c"># May be used to set modifications to the environment for any</span>
        <span class="c"># run_command invocation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_command_environ_update</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_legal_inputs</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;_ansible_check_mode&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_no_log&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_debug&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_diff&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_verbosity&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_selinux_special_fs&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_module_name&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_version&#39;</span><span class="p">,</span> <span class="s">&#39;_ansible_syslog_facility&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">add_file_common_args</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">FILE_COMMON_ARGUMENTS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_params</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_fallbacks</span><span class="p">()</span>

        <span class="c"># append to legal_inputs and then possibly check against them</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_aliases</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="c"># Use exceptions here because it isn&#39;t safe to call fail_json until no_log is processed</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">{&quot;failed&quot;: true, &quot;msg&quot;: &quot;Module alias error: </span><span class="si">%s</span><span class="s">&quot;}&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># Save parameter values that should never be logged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="c"># Use the argspec to determine which args are no_log</span>
        <span class="k">for</span> <span class="n">arg_name</span><span class="p">,</span> <span class="n">arg_opts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">arg_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;no_log&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                <span class="c"># Find the value for the no_log&#39;d param</span>
                <span class="n">no_log_object</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">no_log_object</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">return_values</span><span class="p">(</span><span class="n">no_log_object</span><span class="p">))</span>

        <span class="c"># check the locale as set by the current environment, and reset to</span>
        <span class="c"># a known valid (LANG=C) if it&#39;s an invalid/unavailable locale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_locale</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_arguments</span><span class="p">(</span><span class="n">check_invalid_arguments</span><span class="p">)</span>

        <span class="c"># check exclusive early</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_mutually_exclusive</span><span class="p">(</span><span class="n">mutually_exclusive</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_defaults</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_ARGUMENT_TYPES_DISPATCHER</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;str&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_str</span><span class="p">,</span>
                <span class="s">&#39;list&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_list</span><span class="p">,</span>
                <span class="s">&#39;dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_dict</span><span class="p">,</span>
                <span class="s">&#39;bool&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_bool</span><span class="p">,</span>
                <span class="s">&#39;int&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_int</span><span class="p">,</span>
                <span class="s">&#39;float&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_float</span><span class="p">,</span>
                <span class="s">&#39;path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_path</span><span class="p">,</span>
                <span class="s">&#39;raw&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_raw</span><span class="p">,</span>
                <span class="s">&#39;jsonarg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_jsonarg</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">bypass_checks</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_arguments</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_argument_types</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_argument_values</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_together</span><span class="p">(</span><span class="n">required_together</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_one_of</span><span class="p">(</span><span class="n">required_one_of</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_required_if</span><span class="p">(</span><span class="n">required_if</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_defaults</span><span class="p">(</span><span class="n">pre</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_invocation</span><span class="p">()</span>

        <span class="c"># finally, make sure we&#39;re in a sane working dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cwd</span><span class="p">()</span>

<div class="viewcode-block" id="AnsibleModule.load_file_common_arguments"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.load_file_common_arguments">[docs]</a>    <span class="k">def</span> <span class="nf">load_file_common_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        many modules deal with files, this encapsulates common</span>
<span class="sd">        options that the file module accepts such that it is directly</span>
<span class="sd">        available to all modules and they can share code.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dest&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="c"># if the path is a symlink, and we&#39;re following links, get</span>
        <span class="c"># the target of the link instead for testing</span>
        <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;follow&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">mode</span>   <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;mode&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">owner</span>  <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;owner&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">group</span>  <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;group&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># selinux related options</span>
        <span class="n">seuser</span>    <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;seuser&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">serole</span>    <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;serole&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">setype</span>    <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;setype&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">selevel</span>   <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;selevel&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">secontext</span> <span class="o">=</span> <span class="p">[</span><span class="n">seuser</span><span class="p">,</span> <span class="n">serole</span><span class="p">,</span> <span class="n">setype</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_mls_enabled</span><span class="p">():</span>
            <span class="n">secontext</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">selevel</span><span class="p">)</span>

        <span class="n">default_secontext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_default_context</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">default_secontext</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">secontext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;_default&#39;</span><span class="p">:</span>
                <span class="n">secontext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_secontext</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">owner</span><span class="o">=</span><span class="n">owner</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
            <span class="n">seuser</span><span class="o">=</span><span class="n">seuser</span><span class="p">,</span> <span class="n">serole</span><span class="o">=</span><span class="n">serole</span><span class="p">,</span> <span class="n">setype</span><span class="o">=</span><span class="n">setype</span><span class="p">,</span>
            <span class="n">selevel</span><span class="o">=</span><span class="n">selevel</span><span class="p">,</span> <span class="n">secontext</span><span class="o">=</span><span class="n">secontext</span><span class="p">,</span>
        <span class="p">)</span></div>


    <span class="c"># Detect whether using selinux that is MLS-aware.</span>
    <span class="c"># While this means you can set the level/range with</span>
    <span class="c"># selinux.lsetfilecon(), it may or may not mean that you</span>
    <span class="c"># will get the selevel as part of the context returned</span>
    <span class="c"># by selinux.lgetfilecon().</span>

<div class="viewcode-block" id="AnsibleModule.selinux_mls_enabled"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.selinux_mls_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">selinux_mls_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">selinux</span><span class="o">.</span><span class="n">is_selinux_mls_enabled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="AnsibleModule.selinux_enabled"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.selinux_enabled">[docs]</a>    <span class="k">def</span> <span class="nf">selinux_enabled</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span><span class="p">:</span>
            <span class="n">seenabled</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bin_path</span><span class="p">(</span><span class="s">&#39;selinuxenabled&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">seenabled</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="p">(</span><span class="n">rc</span><span class="p">,</span><span class="n">out</span><span class="p">,</span><span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="n">seenabled</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;Aborting, target uses selinux but python bindings (libselinux-python) aren&#39;t installed!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="n">selinux</span><span class="o">.</span><span class="n">is_selinux_enabled</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span></div>

    <span class="c"># Determine whether we need a placeholder for selevel/mls</span>
<div class="viewcode-block" id="AnsibleModule.selinux_initial_context"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.selinux_initial_context">[docs]</a>    <span class="k">def</span> <span class="nf">selinux_initial_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_mls_enabled</span><span class="p">():</span>
            <span class="n">context</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>

    <span class="k">def</span> <span class="nf">_to_filesystem_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Returns filesystem path as a str, if it wasn&#39;t already.</span>

<span class="sd">        Used in selinux interactions because it cannot accept unicode</span>
<span class="sd">        instances, and specifying complex args in a playbook leaves</span>
<span class="sd">        you with unicode instances.  This method currently assumes</span>
<span class="sd">        that your filesystem encoding is UTF-8.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c"># If selinux fails to find a default, return an array of None</span>
<div class="viewcode-block" id="AnsibleModule.selinux_default_context"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.selinux_default_context">[docs]</a>    <span class="k">def</span> <span class="nf">selinux_default_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_initial_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">selinux</span><span class="o">.</span><span class="n">matchpathcon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_filesystem_str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>
        <span class="c"># Limit split to 4 because the selevel, the last in the list,</span>
        <span class="c"># may contain &#39;:&#39; characters</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="AnsibleModule.selinux_context"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.selinux_context">[docs]</a>    <span class="k">def</span> <span class="nf">selinux_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_initial_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">context</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">selinux</span><span class="o">.</span><span class="n">lgetfilecon_raw</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_filesystem_str</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;path </span><span class="si">%s</span><span class="s"> does not exist&#39;</span> <span class="o">%</span> <span class="n">path</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;failed to retrieve selinux context&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">context</span>
        <span class="c"># Limit split to 4 because the selevel, the last in the list,</span>
        <span class="c"># may contain &#39;:&#39; characters</span>
        <span class="n">context</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">context</span></div>

<div class="viewcode-block" id="AnsibleModule.user_and_group"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.user_and_group">[docs]</a>    <span class="k">def</span> <span class="nf">user_and_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_uid</span>
        <span class="n">gid</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">st_gid</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.find_mount_point"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.find_mount_point">[docs]</a>    <span class="k">def</span> <span class="nf">find_mount_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">path</span><span class="p">)))</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">ismount</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">path</span></div>

<div class="viewcode-block" id="AnsibleModule.is_special_selinux_path"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.is_special_selinux_path">[docs]</a>    <span class="k">def</span> <span class="nf">is_special_selinux_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns a tuple containing (True, selinux_context) if the given path is on a</span>
<span class="sd">        NFS or other &#39;special&#39; fs  mount point, otherwise the return will be (False, None).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/proc/mounts&#39;</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">mount_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">path_mount_point</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_mount_point</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">mount_data</span><span class="p">:</span>
            <span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">mount_point</span><span class="p">,</span> <span class="n">fstype</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">rest</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">path_mount_point</span> <span class="o">==</span> <span class="n">mount_point</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_selinux_special_fs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">fs</span> <span class="ow">in</span> <span class="n">fstype</span><span class="p">:</span>
                        <span class="n">special_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_context</span><span class="p">(</span><span class="n">path_mount_point</span><span class="p">)</span>
                        <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">special_context</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.set_default_selinux_context"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_default_selinux_context">[docs]</a>    <span class="k">def</span> <span class="nf">set_default_selinux_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">changed</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">changed</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_default_context</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_context_if_different</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.set_context_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_context_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_context_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">HAVE_SELINUX</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
            <span class="k">return</span> <span class="n">changed</span>
        <span class="n">cur_context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_context</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">new_context</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cur_context</span><span class="p">)</span>
        <span class="c"># Iterate over the current context instead of the</span>
        <span class="c"># argument context, which may have selevel.</span>

        <span class="p">(</span><span class="n">is_special_se</span><span class="p">,</span> <span class="n">sp_context</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_special_selinux_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">is_special_se</span><span class="p">:</span>
            <span class="n">new_context</span> <span class="o">=</span> <span class="n">sp_context</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cur_context</span><span class="p">)):</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">i</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">cur_context</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="n">new_context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="n">new_context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_context</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">cur_context</span> <span class="o">!=</span> <span class="n">new_context</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;before&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="s">&#39;secontext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur_context</span>
                <span class="k">if</span> <span class="s">&#39;after&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="s">&#39;secontext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_context</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
                <span class="n">rc</span> <span class="o">=</span> <span class="n">selinux</span><span class="o">.</span><span class="n">lsetfilecon</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_to_filesystem_str</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_context</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;invalid selinux context: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">new_context</span><span class="o">=</span><span class="n">new_context</span><span class="p">,</span> <span class="n">cur_context</span><span class="o">=</span><span class="n">cur_context</span><span class="p">,</span> <span class="n">input_was</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;set selinux context failed&#39;</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">changed</span></div>

<div class="viewcode-block" id="AnsibleModule.set_owner_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_owner_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_owner_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">owner</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">owner</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">changed</span>
        <span class="n">orig_uid</span><span class="p">,</span> <span class="n">orig_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_and_group</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">uid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">uid</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">owner</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;chown failed: failed to look up user </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">owner</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig_uid</span> <span class="o">!=</span> <span class="n">uid</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;before&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="s">&#39;owner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_uid</span>
                <span class="k">if</span> <span class="s">&#39;after&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="s">&#39;owner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">lchown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;chown failed&#39;</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">changed</span></div>

<div class="viewcode-block" id="AnsibleModule.set_group_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_group_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_group_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">group</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">changed</span>
        <span class="n">orig_uid</span><span class="p">,</span> <span class="n">orig_gid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_and_group</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">gid</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrnam</span><span class="p">(</span><span class="n">group</span><span class="p">)</span><span class="o">.</span><span class="n">gr_gid</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;chgrp failed: failed to look up group </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">group</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">orig_gid</span> <span class="o">!=</span> <span class="n">gid</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;before&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">orig_gid</span>
                <span class="k">if</span> <span class="s">&#39;after&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gid</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">lchown</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;chgrp failed&#39;</span><span class="p">)</span>
            <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">changed</span></div>

<div class="viewcode-block" id="AnsibleModule.set_mode_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_mode_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_mode_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">changed</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_symbolic_mode_to_octal</span><span class="p">(</span><span class="n">path_stat</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
                                   <span class="n">msg</span><span class="o">=</span><span class="s">&quot;mode must be in octal or symbolic form&quot;</span><span class="p">,</span>
                                   <span class="n">details</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">mode</span> <span class="o">!=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">mode</span><span class="p">):</span>
                    <span class="c"># prevent mode from having extra info orbeing invalid long number</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;Invalid mode supplied, only permission info is allowed&quot;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="n">prev_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">path_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">prev_mode</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">diff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s">&#39;before&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;before&#39;</span><span class="p">][</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">oct</span><span class="p">(</span><span class="n">prev_mode</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&#39;after&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">diff</span><span class="p">:</span>
                    <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">diff</span><span class="p">[</span><span class="s">&#39;after&#39;</span><span class="p">][</span><span class="s">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">oct</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="c"># FIXME: comparison against string above will cause this to be executed</span>
            <span class="c"># every time</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&#39;lchmod&#39;</span><span class="p">):</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">lchmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># Attempt to set the perms of the symlink but be</span>
                        <span class="c"># careful not to change the perms of the underlying</span>
                        <span class="c"># file while trying</span>
                        <span class="n">underlying_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
                        <span class="n">new_underlying_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">underlying_stat</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">!=</span> <span class="n">new_underlying_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">underlying_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>  <span class="c"># Can&#39;t set mode on symbolic links</span>
                    <span class="k">pass</span>
                <span class="k">elif</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">in</span> <span class="p">(</span><span class="n">errno</span><span class="o">.</span><span class="n">ENOENT</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ELOOP</span><span class="p">):</span> <span class="c"># Can&#39;t set mode on broken symbolic links</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">e</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&#39;chmod failed&#39;</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

            <span class="n">path_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">new_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">path_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new_mode</span> <span class="o">!=</span> <span class="n">prev_mode</span><span class="p">:</span>
                <span class="n">changed</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="n">changed</span></div>

    <span class="k">def</span> <span class="nf">_symbolic_mode_to_octal</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">,</span> <span class="n">symbolic_mode</span><span class="p">):</span>
        <span class="n">new_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">path_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>

        <span class="n">mode_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;users&gt;[ugoa]+)(?P&lt;operator&gt;[-+=])(?P&lt;perms&gt;[rwxXst-]*|[ugo])$&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">symbolic_mode</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">mode_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;users&#39;</span><span class="p">)</span>
                <span class="n">operator</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;operator&#39;</span><span class="p">)</span>
                <span class="n">perms</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s">&#39;perms&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">users</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
                    <span class="n">users</span> <span class="o">=</span> <span class="s">&#39;ugo&#39;</span>

                <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
                    <span class="n">mode_to_apply</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_octal_mode_from_symbolic_perms</span><span class="p">(</span><span class="n">path_stat</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">perms</span><span class="p">)</span>
                    <span class="n">new_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_operation_to_mode</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">mode_to_apply</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&quot;bad symbolic permission for mode: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mode</span>

    <span class="k">def</span> <span class="nf">_apply_operation_to_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">operator</span><span class="p">,</span> <span class="n">mode_to_apply</span><span class="p">,</span> <span class="n">current_mode</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">operator</span>  <span class="o">==</span>  <span class="s">&#39;=&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">user</span> <span class="o">==</span> <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISUID</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISGID</span>
            <span class="k">elif</span> <span class="n">user</span> <span class="o">==</span> <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="n">mask</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXO</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISVTX</span>

            <span class="c"># mask out u, g, or o permissions from current_mode and apply new permissions</span>
            <span class="n">inverse_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">^</span> <span class="n">PERM_BITS</span>
            <span class="n">new_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">current_mode</span> <span class="o">&amp;</span> <span class="n">inverse_mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">mode_to_apply</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">new_mode</span> <span class="o">=</span> <span class="n">current_mode</span> <span class="o">|</span> <span class="n">mode_to_apply</span>
        <span class="k">elif</span> <span class="n">operator</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">new_mode</span> <span class="o">=</span> <span class="n">current_mode</span> <span class="o">-</span> <span class="p">(</span><span class="n">current_mode</span> <span class="o">&amp;</span> <span class="n">mode_to_apply</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_mode</span>

    <span class="k">def</span> <span class="nf">_get_octal_mode_from_symbolic_perms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path_stat</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">perms</span><span class="p">):</span>
        <span class="n">prev_mode</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">path_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>

        <span class="n">is_directory</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISDIR</span><span class="p">(</span><span class="n">path_stat</span><span class="o">.</span><span class="n">st_mode</span><span class="p">)</span>
        <span class="n">has_x_permissions</span> <span class="o">=</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">EXEC_PERM_BITS</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">apply_X_permission</span> <span class="o">=</span> <span class="n">is_directory</span> <span class="ow">or</span> <span class="n">has_x_permissions</span>

        <span class="c"># Permission bits constants documented at:</span>
        <span class="c"># http://docs.python.org/2/library/stat.html#stat.S_ISUID</span>
        <span class="k">if</span> <span class="n">apply_X_permission</span><span class="p">:</span>
            <span class="n">X_perms</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">},</span>
                <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span><span class="p">},</span>
                <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">}</span>
            <span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">X_perms</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">},</span>
                <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;X&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
            <span class="p">}</span>

        <span class="n">user_perms_to_modes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span><span class="p">,</span>
                <span class="s">&#39;w&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWUSR</span><span class="p">,</span>
                <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXUSR</span><span class="p">,</span>
                <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISUID</span><span class="p">,</span>
                <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">,</span>
                <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="p">},</span>
            <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span><span class="p">,</span>
                <span class="s">&#39;w&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWGRP</span><span class="p">,</span>
                <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXGRP</span><span class="p">,</span>
                <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISGID</span><span class="p">,</span>
                <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span><span class="p">,</span>
                <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span> <span class="p">},</span>
            <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s">&#39;r&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span><span class="p">,</span>
                <span class="s">&#39;w&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IWOTH</span><span class="p">,</span>
                <span class="s">&#39;x&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IXOTH</span><span class="p">,</span>
                <span class="s">&#39;s&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s">&#39;t&#39;</span><span class="p">:</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_ISVTX</span><span class="p">,</span>
                <span class="s">&#39;u&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXU</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">,</span>
                <span class="s">&#39;g&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXG</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s">&#39;o&#39;</span><span class="p">:</span> <span class="n">prev_mode</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRWXO</span> <span class="p">}</span>
        <span class="p">}</span>

        <span class="c"># Insert X_perms into user_perms_to_modes</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">X_perms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">user_perms_to_modes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">or_reduce</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">mode</span><span class="p">,</span> <span class="n">perm</span><span class="p">:</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">user_perms_to_modes</span><span class="p">[</span><span class="n">user</span><span class="p">][</span><span class="n">perm</span><span class="p">]</span>
        <span class="k">return</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">or_reduce</span><span class="p">,</span> <span class="n">perms</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<div class="viewcode-block" id="AnsibleModule.set_fs_attributes_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_fs_attributes_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_fs_attributes_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_args</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c"># set modes owners and context as needed</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_context_if_different</span><span class="p">(</span>
            <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;secontext&#39;</span><span class="p">],</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span>
        <span class="p">)</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_owner_if_different</span><span class="p">(</span>
            <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;owner&#39;</span><span class="p">],</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span>
        <span class="p">)</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_group_if_different</span><span class="p">(</span>
            <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">],</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span>
        <span class="p">)</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_mode_if_different</span><span class="p">(</span>
            <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">],</span> <span class="n">file_args</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">],</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">changed</span></div>

<div class="viewcode-block" id="AnsibleModule.set_directory_attributes_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_directory_attributes_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_directory_attributes_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_args</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fs_attributes_if_different</span><span class="p">(</span><span class="n">file_args</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.set_file_attributes_if_different"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.set_file_attributes_if_different">[docs]</a>    <span class="k">def</span> <span class="nf">set_file_attributes_if_different</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_args</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fs_attributes_if_different</span><span class="p">(</span><span class="n">file_args</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.add_path_info"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.add_path_info">[docs]</a>    <span class="k">def</span> <span class="nf">add_path_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        for results that are files, supplement the info about the file</span>
<span class="sd">        in the return path with stats about the file path.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;path&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;dest&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">kwargs</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_and_group</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;uid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uid</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;gid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gid</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">user</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">grp</span><span class="o">.</span><span class="n">getgrgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;owner&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">user</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lstat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;mode&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="nb">oct</span><span class="p">(</span><span class="n">stat</span><span class="o">.</span><span class="n">S_IMODE</span><span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_MODE</span><span class="p">]))</span>
            <span class="c"># secontext not yet supported</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">islink</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;link&#39;</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;directory&#39;</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">st_nlink</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;hard&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;file&#39;</span>
            <span class="k">if</span> <span class="n">HAVE_SELINUX</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;secontext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">selinux_context</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="n">stat</span><span class="o">.</span><span class="n">ST_SIZE</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;state&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;absent&#39;</span>
        <span class="k">return</span> <span class="n">kwargs</span></div>

    <span class="k">def</span> <span class="nf">_check_locale</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Uses the locale module to test the currently set locale</span>
<span class="sd">        (per the LANG and LC_CTYPE environment settings)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># setting the locale to &#39;&#39; uses the default locale</span>
            <span class="c"># as it would be returned by locale.getdefaultlocale()</span>
            <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">locale</span><span class="o">.</span><span class="n">Error</span><span class="p">:</span>
            <span class="c"># fallback to the &#39;C&#39; locale, which may cause unicode</span>
            <span class="c"># issues but is preferable to simply failing because</span>
            <span class="c"># of an unknown locale</span>
            <span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s">&#39;C&#39;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LANG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LC_ALL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;LC_MESSAGES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;C&#39;</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;An unknown error was encountered while attempting to validate the locale: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_aliases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># this uses exceptions as it happens before we can safely call fail_json</span>
        <span class="n">aliases_results</span> <span class="o">=</span> <span class="p">{}</span> <span class="c">#alias:canon</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_legal_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
            <span class="n">aliases</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;aliases&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">required</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;required&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">required</span><span class="p">:</span>
                <span class="c"># not alias specific but this is a good place to check this</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;internal error: required and default are mutually exclusive for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">aliases</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">aliases</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">list</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&#39;internal error: aliases must be a list&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">aliases</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_legal_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alias</span><span class="p">)</span>
                <span class="n">aliases_results</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                <span class="k">if</span> <span class="n">alias</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">alias</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">aliases_results</span>

    <span class="k">def</span> <span class="nf">_check_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check_invalid_arguments</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_syslog_facility</span> <span class="o">=</span> <span class="s">&#39;LOG_USER&#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>

            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_check_mode&#39;</span> <span class="ow">and</span> <span class="n">v</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span> <span class="o">=</span> <span class="bp">True</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_no_log&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">no_log</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_debug&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_diff&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_verbosity&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_verbosity</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_selinux_special_fs&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_selinux_special_fs</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_syslog_facility&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_syslog_facility</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_version&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ansible_version</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="s">&#39;_ansible_module_name&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">v</span>

            <span class="k">elif</span> <span class="n">check_invalid_arguments</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_legal_inputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;unsupported parameter for module: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>

            <span class="c">#clean up internal params:</span>
            <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_ansible_&#39;</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_mode</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">supports_check_mode</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exit_json</span><span class="p">(</span><span class="n">skipped</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;remote module (</span><span class="si">%s</span><span class="s">) does not support check mode&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_count_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">check</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">check</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">term</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">def</span> <span class="nf">_check_mutually_exclusive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_terms</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;parameters are mutually exclusive: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">check</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_check_required_one_of</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_terms</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;one of the following is required: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">check</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_required_together</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_terms</span><span class="p">([</span><span class="n">field</span><span class="p">])</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">check</span> <span class="p">]</span>
            <span class="n">non_zero</span> <span class="o">=</span> <span class="p">[</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">counts</span> <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">non_zero</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;parameters are required together: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">check</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">_check_required_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; ensure all required arguments are present &#39;&#39;&#39;</span>
        <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">required</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;required&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;missing required arguments: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_required_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; ensure that parameters which conditionally required are present &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">requirements</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="n">val</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">check</span> <span class="ow">in</span> <span class="n">requirements</span><span class="p">:</span>
                    <span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_terms</span><span class="p">((</span><span class="n">check</span><span class="p">,))</span>
                    <span class="k">if</span> <span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">check</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> is </span><span class="si">%s</span><span class="s"> but the following are missing: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">_check_argument_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; ensure all arguments have the requested values, and there are no stray arguments &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">choices</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;choices&#39;</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">choices</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">SEQUENCETYPE</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">:</span>
                        <span class="n">choices_str</span><span class="o">=</span><span class="s">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">choices</span><span class="p">])</span>
                        <span class="n">msg</span><span class="o">=</span><span class="s">&quot;value of </span><span class="si">%s</span><span class="s"> must be one of: </span><span class="si">%s</span><span class="s">, got: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">choices_str</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;internal error: choices for argument </span><span class="si">%s</span><span class="s"> are not iterable: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">choices</span><span class="p">))</span>

<div class="viewcode-block" id="AnsibleModule.safe_eval"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.safe_eval">[docs]</a>    <span class="k">def</span> <span class="nf">safe_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">locals</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">include_exceptions</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>

        <span class="c"># do not allow method calls to modules</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="c"># already templated to a datastructure, perhaps?</span>
            <span class="k">if</span> <span class="n">include_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;\w\.\w+\(&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">include_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span>
        <span class="c"># do not allow imports</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&#39;import \w+&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">include_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">include_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">result</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">include_exceptions</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">str</span></div>

    <span class="k">def</span> <span class="nf">_check_type_str</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>
        <span class="c"># Note: This could throw a unicode error if value&#39;s __str__() method</span>
        <span class="c"># returns non-ascii.  Have to port utils.to_bytes() if that happens</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_check_type_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">]</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to a list&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;{&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">exc</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">safe_eval</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(),</span> <span class="n">include_exceptions</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;unable to evaluate string as dictionary&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">result</span>
            <span class="k">elif</span> <span class="s">&#39;=&#39;</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">field_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">in_quote</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">in_escape</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">in_escape</span><span class="p">:</span>
                        <span class="n">field_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                        <span class="n">in_escape</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">elif</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">&#39;</span><span class="p">:</span>
                        <span class="n">in_escape</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">in_quote</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                        <span class="n">in_quote</span> <span class="o">=</span> <span class="n">c</span>
                    <span class="k">elif</span> <span class="n">in_quote</span> <span class="ow">and</span> <span class="n">in_quote</span> <span class="o">==</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">in_quote</span> <span class="o">=</span> <span class="bp">False</span>
                    <span class="k">elif</span> <span class="ow">not</span> <span class="n">in_quote</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                        <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_buffer</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                            <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                        <span class="n">field_buffer</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">field_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

                <span class="n">field</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">field_buffer</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">field</span><span class="p">:</span>
                    <span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field</span><span class="p">)</span>
                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;dictionary requested, could not parse JSON or key=value&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to a dict&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to a bool&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to an int&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to a float&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_type_str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_jsonarg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c"># Return a jsonified string.  Sometimes the controller turns a json</span>
        <span class="c"># string into a dict/list so transform it back into json here</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="nb">unicode</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s"> cannot be converted to a json string&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_type_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>


    <span class="k">def</span> <span class="nf">_check_argument_types</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; ensure all arguments have the requested type &#39;&#39;&#39;</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">wanted</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">wanted</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Mostly we want to default to str.</span>
                <span class="c"># For values set to None explicitly, return None instead as</span>
                <span class="c"># that allows a user to unset a parameter</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">wanted</span> <span class="o">=</span> <span class="s">&#39;str&#39;</span>

            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">type_checker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CHECK_ARGUMENT_TYPES_DISPATCHER</span><span class="p">[</span><span class="n">wanted</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;implementation error: unknown type </span><span class="si">%s</span><span class="s"> requested for </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">wanted</span><span class="p">,</span> <span class="n">k</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_checker</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;argument </span><span class="si">%s</span><span class="s"> is of type </span><span class="si">%s</span><span class="s"> and we were unable to convert to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">wanted</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_set_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pre</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="c"># this prevents setting defaults on required items</span>
                <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># make sure things without a default still get set None</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>

    <span class="k">def</span> <span class="nf">_set_fallbacks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">fallback</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;fallback&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">None</span><span class="p">,))</span>
            <span class="n">fallback_strategy</span> <span class="o">=</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">fallback_args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fallback_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="n">fallback_strategy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">fallback</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="n">fallback_kwargs</span> <span class="o">=</span> <span class="n">item</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fallback_args</span> <span class="o">=</span> <span class="n">item</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">fallback_strategy</span><span class="p">(</span><span class="o">*</span><span class="n">fallback_args</span><span class="p">,</span> <span class="o">**</span><span class="n">fallback_kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">AnsibleFallbackNotFound</span><span class="p">:</span>
                    <span class="k">continue</span>

    <span class="k">def</span> <span class="nf">_load_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; read the input and set the params attribute.</span>

<span class="sd">        This method is for backwards compatibility.  The guts of the function</span>
<span class="sd">        were moved out in 2.1 so that custom modules could read the parameters.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># debug overrides to read args from file or cmdline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">_load_params</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_log_to_syslog</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">HAS_SYSLOG</span><span class="p">:</span>
            <span class="n">module</span> <span class="o">=</span> <span class="s">&#39;ansible-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="n">facility</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">syslog</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_syslog_facility</span><span class="p">,</span> <span class="n">syslog</span><span class="o">.</span><span class="n">LOG_USER</span><span class="p">)</span>
            <span class="n">syslog</span><span class="o">.</span><span class="n">openlog</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">module</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">facility</span><span class="p">)</span>
            <span class="n">syslog</span><span class="o">.</span><span class="n">syslog</span><span class="p">(</span><span class="n">syslog</span><span class="o">.</span><span class="n">LOG_INFO</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

<div class="viewcode-block" id="AnsibleModule.debug"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.debug">[docs]</a>    <span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.log"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.log">[docs]</a>    <span class="k">def</span> <span class="nf">log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">log_args</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">log_args</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">log_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="n">module</span> <span class="o">=</span> <span class="s">&#39;ansible-</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">module</span> <span class="o">=</span> <span class="n">module</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">)</span>

            <span class="c"># 6655 - allow for accented characters</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;msg should be a string (got </span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span>

            <span class="c"># We want journal to always take text type</span>
            <span class="c"># syslog takes bytes on py2, text type on py3</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">journal_msg</span> <span class="o">=</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># TODO: surrogateescape is a danger here on Py3</span>
                <span class="n">journal_msg</span> <span class="o">=</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                <span class="n">syslog_msg</span> <span class="o">=</span> <span class="n">journal_msg</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">syslog_msg</span> <span class="o">=</span> <span class="n">journal_msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_journal</span><span class="p">:</span>
                <span class="n">journal_args</span> <span class="o">=</span> <span class="p">[(</span><span class="s">&quot;MODULE&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">__file__</span><span class="p">))]</span>
                <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">log_args</span><span class="p">:</span>
                    <span class="n">journal_args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">arg</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="nb">str</span><span class="p">(</span><span class="n">log_args</span><span class="p">[</span><span class="n">arg</span><span class="p">])))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">journal</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">u&quot;</span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">journal_msg</span><span class="p">),</span> <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">journal_args</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                    <span class="c"># fall back to syslog since logging to journal failed</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_syslog</span><span class="p">(</span><span class="n">syslog_msg</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_syslog</span><span class="p">(</span><span class="n">syslog_msg</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_log_invocation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; log that ansible ran the module &#39;&#39;&#39;</span>
        <span class="c"># TODO: generalize a separate log function and make log_invocation use it</span>
        <span class="c"># Sanitize possible password argument when logging.</span>
        <span class="n">log_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">passwd_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;password&#39;</span><span class="p">,</span> <span class="s">&#39;login_password&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="n">canon</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aliases</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">param</span><span class="p">)</span>
            <span class="n">arg_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argument_spec</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">canon</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">no_log</span> <span class="o">=</span> <span class="n">arg_opts</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;no_log&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boolean</span><span class="p">(</span><span class="n">no_log</span><span class="p">):</span>
                <span class="n">log_args</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NOT_LOGGING_PARAMETER&#39;</span>
            <span class="k">elif</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">passwd_keys</span><span class="p">:</span>
                <span class="n">log_args</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;NOT_LOGGING_PASSWORD&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">param_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                    <span class="n">param_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">param_val</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">param_val</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                    <span class="n">param_val</span> <span class="o">=</span> <span class="n">param_val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
                <span class="n">log_args</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="n">heuristic_log_sanitize</span><span class="p">(</span><span class="n">param_val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">log_args</span><span class="p">:</span>
            <span class="n">arg_val</span> <span class="o">=</span> <span class="n">log_args</span><span class="p">[</span><span class="n">arg</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_val</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">arg_val</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">arg_val</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg_val</span><span class="p">,</span> <span class="nb">unicode</span><span class="p">):</span>
                <span class="n">arg_val</span> <span class="o">=</span> <span class="n">arg_val</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">arg_val</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">msg</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Invoked with </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&#39;Invoked&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">log_args</span><span class="o">=</span><span class="n">log_args</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_set_cwd</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="k">raise</span>
            <span class="k">return</span> <span class="n">cwd</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="c"># we don&#39;t have access to the cwd, probably because of sudo.</span>
            <span class="c"># Try and move to a neutral location to prevent errors</span>
            <span class="k">for</span> <span class="n">cwd</span> <span class="ow">in</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="s">&#39;$HOME&#39;</span><span class="p">),</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">()]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="o">|</span><span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">cwd</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="c"># we won&#39;t error here, as it may *not* be a problem,</span>
        <span class="c"># and we don&#39;t want to break modules unnecessarily</span>
        <span class="k">return</span> <span class="bp">None</span>

<div class="viewcode-block" id="AnsibleModule.get_bin_path"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.get_bin_path">[docs]</a>    <span class="k">def</span> <span class="nf">get_bin_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">opt_dirs</span><span class="o">=</span><span class="p">[]):</span>
        <span class="sd">&#39;&#39;&#39;Find system executable in :envvar:`PATH`.</span>

<span class="sd">        Arg:</span>
<span class="sd">            required (bool): if executable is not found and required is true, :fail_json:</span>
<span class="sd">            opt_dirs (list): optional list of directories to search in addition to :envvar:`PATH`</span>

<span class="sd">        Returns:</span>
<span class="sd">            if :arg: is found return full path; otherwise return None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">sbin_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/sbin&#39;</span><span class="p">,</span> <span class="s">&#39;/usr/sbin&#39;</span><span class="p">,</span> <span class="s">&#39;/usr/local/sbin&#39;</span><span class="p">]</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">opt_dirs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">+=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;PATH&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">pathsep</span><span class="p">)</span>
        <span class="n">bin_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="c"># mangle PATH to include /sbin dirs</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sbin_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paths</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
                <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">is_executable</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="n">bin_path</span> <span class="o">=</span> <span class="n">path</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">required</span> <span class="ow">and</span> <span class="n">bin_path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Failed to find required executable </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bin_path</span></div>

<div class="viewcode-block" id="AnsibleModule.boolean"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.boolean">[docs]</a>    <span class="k">def</span> <span class="nf">boolean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return a bool for the arg &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">arg</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">BOOLEANS_TRUE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">BOOLEANS_FALSE</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Boolean </span><span class="si">%s</span><span class="s"> not in either boolean list&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.jsonify"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.jsonify">[docs]</a>    <span class="k">def</span> <span class="nf">jsonify</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">encoding</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&quot;utf-8&quot;</span><span class="p">,</span> <span class="s">&quot;latin-1&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
            <span class="c"># Old systems using old simplejson module does not support encoding keyword.</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">new_data</span> <span class="o">=</span> <span class="n">json_dict_bytes_to_unicode</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="n">encoding</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">new_data</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
                <span class="k">continue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Invalid unicode encoding encountered&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.from_json"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.from_json">[docs]</a>    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.add_cleanup_file"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.add_cleanup_file">[docs]</a>    <span class="k">def</span> <span class="nf">add_cleanup_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.do_cleanup_files"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.do_cleanup_files">[docs]</a>    <span class="k">def</span> <span class="nf">do_cleanup_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleanup_files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.exit_json"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.exit_json">[docs]</a>    <span class="k">def</span> <span class="nf">exit_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return from the module, without error &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_path_info</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;changed&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;changed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="s">&#39;invocation&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;invocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;module_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_cleanup_files</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.fail_json"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.fail_json">[docs]</a>    <span class="k">def</span> <span class="nf">fail_json</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; return from the module, with an error message &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_path_info</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">assert</span> <span class="s">&#39;msg&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">,</span> <span class="s">&quot;implementation error -- msg to explain the error is required&quot;</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">if</span> <span class="s">&#39;invocation&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;invocation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;module_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">}</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">remove_values</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">do_cleanup_files</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">jsonify</span><span class="p">(</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.fail_on_missing_params"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.fail_on_missing_params">[docs]</a>    <span class="k">def</span> <span class="nf">fail_on_missing_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">required_params</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; This is for checking for required params when we can not check via argspec because we</span>
<span class="sd">        need more information than is simply given in the argspec.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">required_params</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">missing_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">required_param</span> <span class="ow">in</span> <span class="n">required_params</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">required_param</span><span class="p">):</span>
                <span class="n">missing_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">required_param</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_params</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;missing required arguments: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_params</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnsibleModule.digest_from_file"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.digest_from_file">[docs]</a>    <span class="k">def</span> <span class="nf">digest_from_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return hex digest of local file for a digest_method specified by name, or None if file is not present. &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;attempted to take checksum of directory: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>

        <span class="c"># preserve old behaviour where the third parameter was a hash algorithm object</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">algorithm</span><span class="p">,</span> <span class="s">&#39;hexdigest&#39;</span><span class="p">):</span>
            <span class="n">digest_method</span> <span class="o">=</span> <span class="n">algorithm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">digest_method</span> <span class="o">=</span> <span class="n">AVAILABLE_HASH_ALGORITHMS</span><span class="p">[</span><span class="n">algorithm</span><span class="p">]()</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;Could not hash file &#39;</span><span class="si">%s</span><span class="s">&#39; with algorithm &#39;</span><span class="si">%s</span><span class="s">&#39;. Available algorithms: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">algorithm</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AVAILABLE_HASH_ALGORITHMS</span><span class="p">)))</span>

        <span class="n">blocksize</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span>
        <span class="n">infile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
        <span class="n">block</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">block</span><span class="p">:</span>
            <span class="n">digest_method</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">block</span><span class="p">)</span>
            <span class="n">block</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">blocksize</span><span class="p">)</span>
        <span class="n">infile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">digest_method</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnsibleModule.md5"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.md5">[docs]</a>    <span class="k">def</span> <span class="nf">md5</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return MD5 hex digest of local file using digest_from_file().</span>

<span class="sd">        Do not use this function unless you have no other choice for:</span>
<span class="sd">            1) Optional backwards compatibility</span>
<span class="sd">            2) Compatibility with a third party protocol</span>

<span class="sd">        This function will not work on systems complying with FIPS-140-2.</span>

<span class="sd">        Most uses of this function can use the module.sha1 function instead.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;md5&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">AVAILABLE_HASH_ALGORITHMS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s">&#39;MD5 not available.  Possibly running in FIPS mode&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;md5&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.sha1"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.sha1">[docs]</a>    <span class="k">def</span> <span class="nf">sha1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return SHA1 hex digest of local file using digest_from_file(). &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;sha1&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.sha256"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.sha256">[docs]</a>    <span class="k">def</span> <span class="nf">sha256</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39; Return SHA-256 hex digest of local file using digest_from_file(). &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">digest_from_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;sha256&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.backup_local"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.backup_local">[docs]</a>    <span class="k">def</span> <span class="nf">backup_local</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;make a date-marked backup of the specified file, return True or False on success or failure&#39;&#39;&#39;</span>

        <span class="n">backupdest</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="c"># backups named basename-YYYY-MM-DD@HH:MM:SS~</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s">@%H:%M:%S~&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
            <span class="n">backupdest</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">backupdest</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Could not make backup of </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">backupdest</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">backupdest</span></div>

<div class="viewcode-block" id="AnsibleModule.cleanup"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.cleanup">[docs]</a>    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tmpfile</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">tmpfile</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;could not cleanup </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tmpfile</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span></div>

<div class="viewcode-block" id="AnsibleModule.atomic_move"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.atomic_move">[docs]</a>    <span class="k">def</span> <span class="nf">atomic_move</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">unsafe_writes</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;atomically move src to dest, copying attributes from dest, returns true on success</span>
<span class="sd">        it uses os.rename to ensure this as it is an atomic operation, rest of the function is</span>
<span class="sd">        to work around limitations, corner cases and ensure selinux context is saved if possible&#39;&#39;&#39;</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">dest_stat</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dest_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="n">PERM_BITS</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_uid</span><span class="p">,</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_gid</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_context</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
                <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_default_context</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="n">creating</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">login_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getlogin</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="c"># not having a tty can cause the above to fail, so</span>
            <span class="c"># just get the LOGNAME environment variable instead</span>
            <span class="n">login_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;LOGNAME&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="c"># if the original login_name doesn&#39;t match the currently</span>
        <span class="c"># logged-in user, or if the SUDO_USER environment variable</span>
        <span class="c"># is set, then this user has switched their credentials</span>
        <span class="n">switched_user</span> <span class="o">=</span> <span class="n">login_name</span> <span class="ow">and</span> <span class="n">login_name</span> <span class="o">!=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SUDO_USER&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c"># Optimistically try a rename, solves some corner cases and can avoid useless work, throws exception if not atomic.</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EXDEV</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">EACCES</span><span class="p">,</span> <span class="n">errno</span><span class="o">.</span><span class="n">ETXTBSY</span><span class="p">]:</span>
                <span class="c"># only try workarounds for errno 18 (cross device), 1 (not permitted),  13 (permission denied)</span>
                <span class="c"># and 26 (text file busy) which happens on vagrant synced folders and other &#39;exotic&#39; non posix file systems</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Could not replace file: </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dest_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                <span class="n">dest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">dest</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">tmp_dest</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span>
                        <span class="n">prefix</span><span class="o">=</span><span class="s">&quot;.ansible_tmp&quot;</span><span class="p">,</span> <span class="nb">dir</span><span class="o">=</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="n">dest_file</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;The destination directory (</span><span class="si">%s</span><span class="s">) is not writable by the current user. Error was: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest_dir</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                <span class="k">try</span><span class="p">:</span> <span class="c"># leaves tmp file behind when sudo and  not root</span>
                    <span class="k">if</span> <span class="n">switched_user</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c"># cleanup will happen by &#39;rm&#39; of tempdir</span>
                        <span class="c"># copy2 will preserve some metadata</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">set_context_if_different</span><span class="p">(</span>
                            <span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">tmp_stat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dest_stat</span> <span class="ow">and</span> <span class="p">(</span><span class="n">tmp_stat</span><span class="o">.</span><span class="n">st_uid</span> <span class="o">!=</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_uid</span> <span class="ow">or</span> <span class="n">tmp_stat</span><span class="o">.</span><span class="n">st_gid</span> <span class="o">!=</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_gid</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_uid</span><span class="p">,</span> <span class="n">dest_stat</span><span class="o">.</span><span class="n">st_gid</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                        <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">!=</span> <span class="n">errno</span><span class="o">.</span><span class="n">EPERM</span><span class="p">:</span>
                            <span class="k">raise</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                    <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                    <span class="c"># sadly there are some situations where we cannot ensure atomicity, but only if</span>
                    <span class="c"># the user insists and we get the appropriate error we update the file unsafely</span>
                    <span class="k">if</span> <span class="n">unsafe_writes</span> <span class="ow">and</span> <span class="n">e</span><span class="o">.</span><span class="n">errno</span> <span class="o">==</span> <span class="n">errno</span><span class="o">.</span><span class="n">EBUSY</span><span class="p">:</span>
                        <span class="c">#TODO: issue warning that this is an unsafe operation, but doing it cause user insists</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">out_dest</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
                                <span class="n">in_src</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">in_src</span><span class="p">,</span> <span class="n">out_dest</span><span class="p">)</span>
                            <span class="k">finally</span><span class="p">:</span> <span class="c"># assuring closed files in 2.4 compatible way</span>
                                <span class="k">if</span> <span class="n">out_dest</span><span class="p">:</span>
                                    <span class="n">out_dest</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">in_src</span><span class="p">:</span>
                                    <span class="n">in_src</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                        <span class="k">except</span> <span class="p">(</span><span class="n">shutil</span><span class="o">.</span><span class="n">Error</span><span class="p">,</span> <span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Could not write data to file (</span><span class="si">%s</span><span class="s">) from (</span><span class="si">%s</span><span class="s">): </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&#39;Could not replace file: </span><span class="si">%s</span><span class="s"> to </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">tmp_dest</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">creating</span><span class="p">:</span>
            <span class="c"># make sure the file has the correct permissions</span>
            <span class="c"># based on the current value of umask</span>
            <span class="n">umask</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">umask</span><span class="p">(</span><span class="n">umask</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">DEFAULT_PERM</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">umask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">switched_user</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">getgid</span><span class="p">())</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">selinux_enabled</span><span class="p">():</span>
            <span class="c"># rename might not preserve context</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_context_if_different</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.run_command"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.run_command">[docs]</a>    <span class="k">def</span> <span class="nf">run_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">check_rc</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">binary_data</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">path_prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cwd</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_unsafe_shell</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">prompt_regex</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">environ_update</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Execute a command, returns rc, stdout, and stderr.</span>

<span class="sd">        :arg args: is the command to run</span>
<span class="sd">            * If args is a list, the command will be run with shell=False.</span>
<span class="sd">            * If args is a string and use_unsafe_shell=False it will split args to a list and run with shell=False</span>
<span class="sd">            * If args is a string and use_unsafe_shell=True it runs with shell=True.</span>
<span class="sd">        :kw check_rc: Whether to call fail_json in case of non zero RC.</span>
<span class="sd">            Default False</span>
<span class="sd">        :kw close_fds: See documentation for subprocess.Popen(). Default True</span>
<span class="sd">        :kw executable: See documentation for subprocess.Popen(). Default None</span>
<span class="sd">        :kw data: If given, information to write to the stdin of the command</span>
<span class="sd">        :kw binary_data: If False, append a newline to the data.  Default False</span>
<span class="sd">        :kw path_prefix: If given, additional path to find the command in.</span>
<span class="sd">            This adds to the PATH environment vairable so helper commands in</span>
<span class="sd">            the same directory can also be found</span>
<span class="sd">        :kw cwd: iIf given, working directory to run the command inside</span>
<span class="sd">        :kw use_unsafe_shell: See `args` parameter.  Default False</span>
<span class="sd">        :kw prompt_regex: Regex string (not a compiled regex) which can be</span>
<span class="sd">            used to detect prompts in the stdout which would otherwise cause</span>
<span class="sd">            the execution to hang (especially if no input data is specified)</span>
<span class="sd">        :kwarg environ_update: dictionary to *update* os.environ with</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">shell</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">use_unsafe_shell</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">pipes</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">])</span>
                <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">)</span> <span class="ow">and</span> <span class="n">use_unsafe_shell</span><span class="p">:</span>
            <span class="n">shell</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="c"># On python2.6 and below, shlex has problems with text type</span>
            <span class="c"># On python3, shlex needs a text type.</span>
            <span class="k">if</span> <span class="n">PY2</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">PY3</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">binary_type</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Argument &#39;args&#39; to run_command must be list or string&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="mi">257</span><span class="p">,</span> <span class="n">cmd</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">prompt_re</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span> <span class="n">prompt_regex</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prompt_regex</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                    <span class="n">prompt_regex</span> <span class="o">=</span> <span class="n">prompt_regex</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;surrogateescape&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">PY2</span><span class="p">:</span>
                    <span class="n">prompt_regex</span> <span class="o">=</span> <span class="n">prompt_regex</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">prompt_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">prompt_regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">MULTILINE</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s">&quot;invalid prompt regular expression given to run_command&quot;</span><span class="p">)</span>

        <span class="c"># expand things like $HOME and ~</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shell</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="p">]</span>

        <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">st_in</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># Manipulate the environ we&#39;ll send to the new process</span>
        <span class="n">old_env_vals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># We can set this from both an attribute and per call</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_command_environ_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">old_env_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">environ_update</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">environ_update</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">old_env_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">path_prefix</span><span class="p">:</span>
            <span class="n">old_env_vals</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path_prefix</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PATH&#39;</span><span class="p">])</span>

        <span class="c"># If using test-module and explode, the remote lib path will resemble ...</span>
        <span class="c">#   /tmp/test_module_scratch/debug_dir/ansible/module_utils/basic.py</span>
        <span class="c"># If using ansible or ansible-playbook with a remote system ...</span>
        <span class="c">#   /tmp/ansible_vmweLQ/ansible_modlib.zip/ansible/module_utils/basic.py</span>

        <span class="c"># Clean out python paths set by ziploader</span>
        <span class="k">if</span> <span class="s">&#39;PYTHONPATH&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
            <span class="n">pypaths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">pypaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pypaths</span> \
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/ansible_modlib.zip&#39;</span><span class="p">)</span> \
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;/debug_dir&#39;</span><span class="p">)]</span>
            <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;PYTHONPATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;:&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pypaths</span><span class="p">)</span>

        <span class="c"># create a printable version of the command for use</span>
        <span class="c"># in reporting later, which strips out things like</span>
        <span class="c"># passwords from the args list</span>
        <span class="n">to_clean_args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">if</span> <span class="n">PY2</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                <span class="n">to_clean_args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">binary_type</span><span class="p">):</span>
                <span class="n">to_clean_args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s">&#39;replace&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="n">text_type</span><span class="p">,</span> <span class="n">binary_type</span><span class="p">)):</span>
            <span class="n">to_clean_args</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">to_clean_args</span><span class="p">)</span>

        <span class="n">clean_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">is_passwd</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">to_clean_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_passwd</span><span class="p">:</span>
                <span class="n">is_passwd</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="n">clean_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;********&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">PASSWD_ARG_RE</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
                <span class="n">sep_idx</span> <span class="o">=</span> <span class="n">arg</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;=&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sep_idx</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">clean_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=********&#39;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">[:</span><span class="n">sep_idx</span><span class="p">])</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">is_passwd</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="n">heuristic_log_sanitize</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>
            <span class="n">clean_args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="n">clean_args</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pipes</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">clean_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">st_in</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="n">shell</span><span class="p">,</span>
            <span class="n">close_fds</span><span class="o">=</span><span class="n">close_fds</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">st_in</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">):</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;cwd&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cwd</span>

        <span class="c"># store the pwd</span>
        <span class="n">prev_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="c"># make sure we&#39;re in the right working directory</span>
        <span class="k">if</span> <span class="n">cwd</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="s">&quot;Could not open </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">running</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">running</span> <span class="o">=</span> <span class="n">args</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s">&#39;Executing: &#39;</span> <span class="o">+</span> <span class="n">running</span><span class="p">)</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c"># the communication logic here is essentially taken from that</span>
            <span class="c"># of the _communicate() function in ssh.py</span>

            <span class="n">stdout</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">stderr</span> <span class="o">=</span> <span class="n">b</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">rpipes</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmd</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cmd</span><span class="o">.</span><span class="n">stderr</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">binary_data</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">text_type</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
                        <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;surrogateescape&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">errors</span> <span class="o">=</span> <span class="s">&#39;strict&#39;</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">cmd</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">rfd</span><span class="p">,</span> <span class="n">wfd</span><span class="p">,</span> <span class="n">efd</span> <span class="o">=</span> <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">rpipes</span><span class="p">,</span> <span class="p">[],</span> <span class="n">rpipes</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">in</span> <span class="n">rfd</span><span class="p">:</span>
                    <span class="n">dat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">9000</span><span class="p">)</span>
                    <span class="n">stdout</span> <span class="o">+=</span> <span class="n">dat</span>
                    <span class="k">if</span> <span class="n">dat</span> <span class="o">==</span> <span class="n">b</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">rpipes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cmd</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">in</span> <span class="n">rfd</span><span class="p">:</span>
                    <span class="n">dat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">9000</span><span class="p">)</span>
                    <span class="n">stderr</span> <span class="o">+=</span> <span class="n">dat</span>
                    <span class="k">if</span> <span class="n">dat</span> <span class="o">==</span> <span class="n">b</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">rpipes</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cmd</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="c"># if we&#39;re checking for prompts, do it now</span>
                <span class="k">if</span> <span class="n">prompt_re</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prompt_re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                        <span class="k">return</span> <span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="s">&quot;A prompt was encountered while running a command, but no input data was specified&quot;</span><span class="p">)</span>
                <span class="c"># only break out if no pipes are left to read or</span>
                <span class="c"># the pipes are completely read and</span>
                <span class="c"># the process is terminated</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">rpipes</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rfd</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="c"># No pipes are left to read but process is not yet terminated</span>
                <span class="c"># Only then it is safe to wait for the process to be finished</span>
                <span class="c"># NOTE: Actually cmd.poll() is always None here if rpipes is empty</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">rpipes</span> <span class="ow">and</span> <span class="n">cmd</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">cmd</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                    <span class="c"># The process is terminated. Since no pipes to read from are</span>
                    <span class="c"># left, there is no need to call select() again.</span>
                    <span class="k">break</span>

            <span class="n">cmd</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">cmd</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">rc</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">returncode</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">):</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">get_exception</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">cmd</span><span class="o">=</span><span class="n">clean_args</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">rc</span><span class="o">=</span><span class="mi">257</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">(),</span> <span class="n">cmd</span><span class="o">=</span><span class="n">clean_args</span><span class="p">)</span>

        <span class="c"># Restore env settings</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">old_env_vals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>

        <span class="k">if</span> <span class="n">rc</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">check_rc</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">heuristic_log_sanitize</span><span class="p">(</span><span class="n">stderr</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_log_values</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fail_json</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="n">clean_args</span><span class="p">,</span> <span class="n">rc</span><span class="o">=</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">stderr</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="n">msg</span><span class="p">)</span>

        <span class="c"># reset the pwd</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">prev_dir</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="p">)</span></div>

<div class="viewcode-block" id="AnsibleModule.append_to_file"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.append_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">append_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expandvars</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnsibleModule.pretty_bytes"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.AnsibleModule.pretty_bytes">[docs]</a>    <span class="k">def</span> <span class="nf">pretty_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">size</span><span class="p">):</span>
        <span class="n">ranges</span> <span class="o">=</span> <span class="p">(</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">70</span><span class="p">,</span> <span class="s">&#39;ZB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">60</span><span class="p">,</span> <span class="s">&#39;EB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">50</span><span class="p">,</span> <span class="s">&#39;PB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">40</span><span class="p">,</span> <span class="s">&#39;TB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">30</span><span class="p">,</span> <span class="s">&#39;GB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">20</span><span class="p">,</span> <span class="s">&#39;MB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">10</span><span class="p">,</span> <span class="s">&#39;KB&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;Bytes&#39;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">limit</span><span class="p">,</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">ranges</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;=</span> <span class="n">limit</span><span class="p">:</span>
                <span class="k">break</span>
        <span class="k">return</span> <span class="s">&#39;</span><span class="si">%.2f</span><span class="s"> </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">size</span><span class="p">)</span><span class="o">/</span> <span class="n">limit</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span></div>

    <span class="c">#</span>
    <span class="c"># Backwards compat</span>
    <span class="c">#</span>

    <span class="c"># In 2.0, moved from inside the module to the toplevel</span>
    <span class="n">is_executable</span> <span class="o">=</span> <span class="n">is_executable</span></div>


<div class="viewcode-block" id="get_module_path"><a class="viewcode-back" href="../../../rst/ansible.module_utils.html#ansible.module_utils.basic.get_module_path">[docs]</a><span class="k">def</span> <span class="nf">get_module_path</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">))</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Red Hat.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>