

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ansible.parsing.mod_args &mdash; Ansible 1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Ansible 1 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Ansible
          

          
          </a>

          
            
            
              <div class="version">
                2.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="simple">
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../../index.html">Ansible</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      
    <li>ansible.parsing.mod_args</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ansible.parsing.mod_args</h1><div class="highlight"><pre>
<span class="c"># (c) 2014 Michael DeHaan, &lt;michael@ansible.com&gt;</span>
<span class="c">#</span>
<span class="c"># This file is part of Ansible</span>
<span class="c">#</span>
<span class="c"># Ansible is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># Ansible is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with Ansible.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="c"># Make coding more python3-ish</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">)</span>
<span class="n">__metaclass__</span> <span class="o">=</span> <span class="nb">type</span>

<span class="kn">from</span> <span class="nn">ansible.compat.six</span> <span class="kn">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">string_types</span>

<span class="kn">from</span> <span class="nn">ansible.errors</span> <span class="kn">import</span> <span class="n">AnsibleParserError</span><span class="p">,</span><span class="n">AnsibleError</span>
<span class="kn">from</span> <span class="nn">ansible.plugins</span> <span class="kn">import</span> <span class="n">module_loader</span>
<span class="kn">from</span> <span class="nn">ansible.parsing.splitter</span> <span class="kn">import</span> <span class="n">parse_kv</span><span class="p">,</span> <span class="n">split_args</span>
<span class="kn">from</span> <span class="nn">ansible.template</span> <span class="kn">import</span> <span class="n">Templar</span>

<span class="c"># For filtering out modules correctly below</span>
<span class="n">RAW_PARAM_MODULES</span> <span class="o">=</span> <span class="p">([</span>
    <span class="s">&#39;command&#39;</span><span class="p">,</span>
    <span class="s">&#39;shell&#39;</span><span class="p">,</span>
    <span class="s">&#39;script&#39;</span><span class="p">,</span>
    <span class="s">&#39;include&#39;</span><span class="p">,</span>
    <span class="s">&#39;include_vars&#39;</span><span class="p">,</span>
    <span class="s">&#39;add_host&#39;</span><span class="p">,</span>
    <span class="s">&#39;group_by&#39;</span><span class="p">,</span>
    <span class="s">&#39;set_fact&#39;</span><span class="p">,</span>
    <span class="s">&#39;raw&#39;</span><span class="p">,</span>
    <span class="s">&#39;meta&#39;</span><span class="p">,</span>
<span class="p">])</span>

<div class="viewcode-block" id="ModuleArgsParser"><a class="viewcode-back" href="../../../rst/ansible.parsing.html#ansible.parsing.mod_args.ModuleArgsParser">[docs]</a><span class="k">class</span> <span class="nc">ModuleArgsParser</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Base module argument parsing class.</span>

<span class="sd">    There are several ways a module and argument set can be expressed::</span>

<span class="sd">        # legacy form (for a shell command)</span>
<span class="sd">        - action: shell echo hi</span>

<span class="sd">        # common shorthand for local actions vs delegate_to</span>
<span class="sd">        - local_action: shell echo hi</span>

<span class="sd">        # most commonly:</span>
<span class="sd">        - copy: src=a dest=b</span>

<span class="sd">        # legacy form</span>
<span class="sd">        - action: copy src=a dest=b</span>

<span class="sd">        # complex args form, for passing structured data</span>
<span class="sd">        - copy:</span>
<span class="sd">            src: a</span>
<span class="sd">            dest: b</span>

<span class="sd">        # gross, but technically legal</span>
<span class="sd">        - action:</span>
<span class="sd">            module: copy</span>
<span class="sd">            args:</span>
<span class="sd">            src: a</span>
<span class="sd">            dest: b</span>

<span class="sd">        # extra gross, but also legal. in this case, the args specified</span>
<span class="sd">        # will act as &#39;defaults&#39; and will be overridden by any args specified</span>
<span class="sd">        # in one of the other formats (complex args under the action, or</span>
<span class="sd">        # parsed from the k=v string</span>
<span class="sd">        - command: &#39;pwd&#39;</span>
<span class="sd">        args:</span>
<span class="sd">            chdir: &#39;/tmp&#39;</span>


<span class="sd">    This class has some of the logic to canonicalize these into the form::</span>

<span class="sd">        - module: &lt;module_name&gt;</span>
<span class="sd">        delegate_to: &lt;optional&gt;</span>
<span class="sd">        args: &lt;args&gt;</span>

<span class="sd">    Args may also be munged for certain shell command parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_ds</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">task_ds</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span> <span class="o">=</span> <span class="n">task_ds</span>


    <span class="k">def</span> <span class="nf">_split_module_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module_string</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        when module names are expressed like:</span>
<span class="sd">        action: copy src=a dest=b</span>
<span class="sd">        the first part of the string is the name of the module</span>
<span class="sd">        and the rest are strings pertaining to the arguments.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">tokens</span> <span class="o">=</span> <span class="n">split_args</span><span class="p">(</span><span class="n">module_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&quot;&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_handle_shell_weirdness</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        given an action name and an args dictionary, return the</span>
<span class="sd">        proper action name and args dictionary.  This mostly is due</span>
<span class="sd">        to shell/command being treated special and nothing else</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># don&#39;t handle non shell/command modules in this function</span>
        <span class="c"># TODO: in terms of the whole app, should &#39;raw&#39; also fit here?</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;shell&#39;</span><span class="p">,</span> <span class="s">&#39;command&#39;</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="c"># the shell module really is the command module with an additional</span>
        <span class="c"># parameter</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s">&#39;shell&#39;</span><span class="p">:</span>
            <span class="n">action</span> <span class="o">=</span> <span class="s">&#39;command&#39;</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;_uses_shell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="nb">dict</span><span class="p">()):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        arguments can be fuzzy.  Deal with all the forms.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c"># final args are the ones we&#39;ll eventually return, so first update</span>
        <span class="c"># them with any additional args specified, which have lower priority</span>
        <span class="c"># than those which may be parsed/normalized next</span>
        <span class="n">final_args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">additional_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_args</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                <span class="n">templar</span> <span class="o">=</span> <span class="n">Templar</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">templar</span><span class="o">.</span><span class="n">_contains_vars</span><span class="p">(</span><span class="n">additional_args</span><span class="p">):</span>
                    <span class="n">final_args</span><span class="p">[</span><span class="s">&#39;_variable_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">additional_args</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;Complex args containing variables cannot use bare variables, and must use the full variable style (&#39;{{var_name}}&#39;)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">additional_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">final_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">additional_args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&#39;Complex args must be a dictionary or variable string (&quot;{{var}}&quot;).&#39;</span><span class="p">)</span>

        <span class="c"># how we normalize depends if we figured out what the module name is</span>
        <span class="c"># yet.  If we have already figured it out, it&#39;s an &#39;old style&#39; invocation.</span>
        <span class="c"># otherwise, it&#39;s not</span>

        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_old_style_args</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_new_style_args</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>

            <span class="c"># this can occasionally happen, simplify</span>
            <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="s">&#39;args&#39;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">tmp_args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tmp_args</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
                    <span class="n">tmp_args</span> <span class="o">=</span> <span class="n">parse_kv</span><span class="p">(</span><span class="n">tmp_args</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tmp_args</span><span class="p">)</span>

        <span class="c"># only internal variables can start with an underscore, so</span>
        <span class="c"># we don&#39;t allow users to set them directy in arguments</span>
        <span class="k">if</span> <span class="n">args</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;shell&#39;</span><span class="p">,</span> <span class="s">&#39;script&#39;</span><span class="p">,</span> <span class="s">&#39;raw&#39;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;_ansible_&#39;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">AnsibleError</span><span class="p">(</span><span class="s">&quot;invalid parameter specified for action &#39;</span><span class="si">%s</span><span class="s">&#39;: &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">arg</span><span class="p">))</span>

        <span class="c"># finally, update the args we&#39;re going to return with the ones</span>
        <span class="c"># which were normalized above</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">final_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">final_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_normalize_old_style_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        deals with fuzziness in old-style (action/local_action) module invocations</span>
<span class="sd">        returns tuple of (module_name, dictionary_args)</span>

<span class="sd">        possible example inputs:</span>
<span class="sd">            { &#39;local_action&#39; : &#39;shell echo hi&#39; }</span>
<span class="sd">            { &#39;action&#39;       : &#39;shell echo hi&#39; }</span>
<span class="sd">            { &#39;local_action&#39; : { &#39;module&#39; : &#39;ec2&#39;, &#39;x&#39; : 1, &#39;y&#39;: 2 }}</span>
<span class="sd">        standardized outputs like:</span>
<span class="sd">            ( &#39;command&#39;, { _raw_params: &#39;echo hi&#39;, _uses_shell: True }</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c"># form is like: local_action: { module: &#39;xyz&#39;, x: 2, y: 3 } ... uncommon!</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">thing</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="c"># form is like: local_action: copy src=a dest=b ... pretty common</span>
            <span class="n">check_raw</span> <span class="o">=</span> <span class="n">action</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;shell&#39;</span><span class="p">,</span> <span class="s">&#39;script&#39;</span><span class="p">,</span> <span class="s">&#39;raw&#39;</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parse_kv</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">check_raw</span><span class="o">=</span><span class="n">check_raw</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">thing</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="c"># this can happen with modules which take no params, like ping:</span>
            <span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;unexpected parameter type in action: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_normalize_new_style_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        deals with fuzziness in new style module invocations</span>
<span class="sd">        accepting key=value pairs and dictionaries, and always returning dictionaries</span>
<span class="sd">        returns tuple of (module_name, dictionary_args)</span>

<span class="sd">        possible example inputs:</span>
<span class="sd">           { &#39;shell&#39; : &#39;echo hi&#39; }</span>
<span class="sd">           { &#39;ec2&#39;   : { &#39;region&#39; : &#39;xyz&#39; }</span>
<span class="sd">           { &#39;ec2&#39;   : &#39;region=xyz&#39; }</span>
<span class="sd">        standardized outputs like:</span>
<span class="sd">           (&#39;ec2&#39;, { region: &#39;xyz&#39;} )</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">action</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">args</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">actions_allowing_raw</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;shell&#39;</span><span class="p">,</span> <span class="s">&#39;script&#39;</span><span class="p">,</span> <span class="s">&#39;raw&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="c"># form is like:  copy: { src: &#39;a&#39;, dest: &#39;b&#39; } ... common for structured (aka &quot;complex&quot;) args</span>
            <span class="n">thing</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="s">&#39;module&#39;</span> <span class="ow">in</span> <span class="n">thing</span><span class="p">:</span>
                <span class="n">action</span><span class="p">,</span> <span class="n">module_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_module_string</span><span class="p">(</span><span class="n">thing</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">])</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">thing</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">check_raw</span> <span class="o">=</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions_allowing_raw</span>
                <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parse_kv</span><span class="p">(</span><span class="n">module_args</span><span class="p">,</span> <span class="n">check_raw</span><span class="o">=</span><span class="n">check_raw</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">args</span><span class="p">[</span><span class="s">&#39;module&#39;</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">string_types</span><span class="p">):</span>
            <span class="c"># form is like:  copy: src=a dest=b ... common shorthand throughout ansible</span>
            <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_module_string</span><span class="p">(</span><span class="n">thing</span><span class="p">)</span>
            <span class="n">check_raw</span> <span class="o">=</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">actions_allowing_raw</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">parse_kv</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">check_raw</span><span class="o">=</span><span class="n">check_raw</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># need a dict or a string, so giving up</span>
            <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;unexpected parameter type in action: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">thing</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="ModuleArgsParser.parse"><a class="viewcode-back" href="../../../rst/ansible.parsing.html#ansible.parsing.mod_args.ModuleArgsParser.parse">[docs]</a>    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Given a task in one of the supported forms, parses and returns</span>
<span class="sd">        returns the action, arguments, and delegate_to values for the</span>
<span class="sd">        task, dealing with all sorts of levels of fuzziness.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">thing</span>      <span class="o">=</span> <span class="bp">None</span>

        <span class="n">action</span>      <span class="o">=</span> <span class="bp">None</span>
        <span class="n">delegate_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;delegate_to&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">args</span>        <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>


        <span class="c"># this is the &#39;extra gross&#39; scenario detailed above, so we grab</span>
        <span class="c"># the args and pass them in as additional arguments, which can/will</span>
        <span class="c"># be overwritten via dict updates from the other arg sources below</span>
        <span class="n">additional_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;args&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>

        <span class="c"># We can have one of action, local_action, or module specified</span>
        <span class="c"># action</span>
        <span class="k">if</span> <span class="s">&#39;action&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">:</span>
            <span class="c"># an old school &#39;action&#39; statement</span>
            <span class="n">thing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">[</span><span class="s">&#39;action&#39;</span><span class="p">]</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_parameters</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">)</span>

        <span class="c"># local_action</span>
        <span class="k">if</span> <span class="s">&#39;local_action&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">:</span>
            <span class="c"># local_action is similar but also implies a delegate_to</span>
            <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;action and local_action are mutually exclusive&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>
            <span class="n">thing</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;local_action&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
            <span class="n">delegate_to</span> <span class="o">=</span> <span class="s">&#39;localhost&#39;</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_parameters</span><span class="p">(</span><span class="n">thing</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">)</span>

        <span class="c"># module: &lt;stuff&gt; is the more new-style invocation</span>

        <span class="c"># walk the input dictionary to see we recognize a module name</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">module_loader</span> <span class="ow">or</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;meta&#39;</span> <span class="ow">or</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&#39;include&#39;</span><span class="p">:</span>
                <span class="c"># finding more than one module name is a problem</span>
                <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;conflicting action statements&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">item</span>
                <span class="n">thing</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">action</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_parameters</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="n">action</span><span class="p">,</span> <span class="n">additional_args</span><span class="o">=</span><span class="n">additional_args</span><span class="p">)</span>

        <span class="c"># if we didn&#39;t see any module in the task at all, it&#39;s not a task really</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;ping&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">module_loader</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;The requested action was not found in configured module paths. &quot;</span>
                        <span class="s">&quot;Additionally, core modules are missing. If this is a checkout, &quot;</span>
                        <span class="s">&quot;run &#39;git submodule update --init --recursive&#39; to correct this problem.&quot;</span><span class="p">,</span>
                        <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;no action detected in task. This often indicates a misspelled module name, or incorrect module path.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;_raw_params&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span> <span class="ow">and</span> <span class="n">action</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RAW_PARAM_MODULES</span><span class="p">:</span>
            <span class="n">templar</span> <span class="o">=</span> <span class="n">Templar</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
            <span class="n">raw_params</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_raw_params&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">templar</span><span class="o">.</span><span class="n">_contains_vars</span><span class="p">(</span><span class="n">raw_params</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="s">&#39;_variable_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_params</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AnsibleParserError</span><span class="p">(</span><span class="s">&quot;this task &#39;</span><span class="si">%s</span><span class="s">&#39; has extra params, which is only allowed in the following modules: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RAW_PARAM_MODULES</span><span class="p">)),</span> <span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_ds</span><span class="p">)</span>

        <span class="c"># shell modules require special handling</span>
        <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_handle_shell_weirdness</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">delegate_to</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Red Hat.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>